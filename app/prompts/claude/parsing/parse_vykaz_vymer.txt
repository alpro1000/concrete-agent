# V√ùKAZ V√ùMƒöR PARSER

You are parsing a Czech construction document "v√Ωkaz v√Ωmƒõr" (bill of quantities).

## TASK
Extract ALL positions from the document with their details.

## INPUT FORMAT
The document may be:
- Excel with columns: Poz. (position), Popis (description), MJ (unit), Mno≈æstv√≠ (quantity), Cena/MJ (unit price), Celkem (total)
- PDF with similar structure
- Czech language

## OUTPUT FORMAT
Return ONLY valid JSON (no markdown, no explanation):
```json
{
  "document_info": {
    "document_name": "...",
    "project_name": "...",
    "date": "...",
    "contractor": "..."
  },
  "total_positions": <number>,
  "positions": [
    {
      "position_number": "1",
      "description": "Betonov√° deska C25/30, tl. 200mm",
      "quantity": 150.5,
      "unit": "m¬≥",
      "unit_price": 2450.00,
      "total_price": 368725.00,
      "category": "HSV",
      "notes": ""
    }
  ]
}
EXTRACTION RULES

Extract ALL positions (don't skip any)
Position number: keep original format (1, 1.1, A.1, etc.)
Description: full Czech text
Quantity: extract number only (remove text)
Unit: Czech abbreviations (m¬≥, m¬≤, kg, ks, soubor, hod, etc.)
Prices: numbers only (remove currency, spaces)
Category: HSV (hlavn√≠ stavebn√≠ v√Ωroba), PSV (pomocn√©), M (materi√°ly), etc.
If data missing: use null

COMMON CZECH TERMS

Poz./ƒå./# = Position number
Popis/N√°zev = Description
MJ/Jednotka = Unit
Mno≈æstv√≠ = Quantity
Cena/MJ = Unit price
Celkem = Total price
HSV = Main construction work
PSV = Auxiliary construction work

QUALITY CHECKS

Verify all positions extracted
Check that quantity √ó unit_price ‚âà total_price (¬±5%)
Ensure units are standard Czech units
Preserve original position numbering

Return ONLY the JSON, nothing else.

---

### 2. `app/prompts/claude/audit/audit_position.txt`
CONSTRUCTION POSITION AUDIT
You are auditing a construction position from a Czech building project.
TASK
Perform 3 checks:

CODE MATCHING - Find appropriate code from KROS/RTS database
PRICE CHECK - Compare with market rates
NORM VALIDATION - Check ƒåSN compliance

INPUT DATA
Below you will receive:

Position to audit (description, quantity, unit, price)
KROS database sample (Czech construction codes)
ƒåSN standards sample (if relevant)

OUTPUT FORMAT
Return ONLY valid JSON:
json{
  "position_number": "...",
  "status": "GREEN|AMBER|RED",
  "code_match": {
    "found": true,
    "code": "121-01-015",
    "name": "Betonov√© konstrukce monolitick√©",
    "confidence": 0.95,
    "source": "KROS 4",
    "alternatives": [],
    "notes": ""
  },
  "price_check": {
    "given_price": 2850.00,
    "market_price": 2450.00,
    "difference_pct": 16.3,
    "status": "AMBER",
    "analysis": "Price 16% above market average",
    "breakdown": null
  },
  "norm_validation": {
    "compliant": true,
    "standards_checked": [
      {"code": "ƒåSN EN 206", "status": "OK"}
    ],
    "issues": [],
    "recommendations": []
  },
  "overall_assessment": {
    "classification": "AMBER",
    "confidence": 0.75,
    "main_issues": [
      "Price 16% above market"
    ],
    "recommendations": [
      "Request price justification",
      "Compare with alternative suppliers"
    ],
    "estimated_savings": 60200.00
  },
  "hitl_required": true,
  "hitl_reason": "Price difference exceeds 15% threshold"
}
CLASSIFICATION RULES
GREEN (95%+ OK)

Correct code match (confidence >0.9)
Price within ¬±10% of market
ƒåSN compliant
No major issues

AMBER (75-95% OK)

Code match uncertain (confidence 0.5-0.9)
Price ¬±10-20% of market
Minor norm issues
Needs review

RED (<75% OK)

No code match (confidence <0.5)
Price >20% off market
Major norm violations
Critical issues

HITL TRIGGERS
Request human review if:

Classification is RED
Price difference >15%
Code confidence <0.5
Norm violations found

CODE MATCHING LOGIC

Search KROS database by keywords
Match by construction type
Consider quantity and unit
Return top match + alternatives

PRICE CHECK LOGIC

Compare given price with market rates
Consider:

Material costs (60-70%)
Labor costs (20-25%)
Equipment (5-10%)
Overhead (5-10%)


Flag if difference >10%

NORM VALIDATION LOGIC

Identify relevant ƒåSN standards
Check compliance with:

Material specifications
Quality requirements
Safety standards


Flag violations

Return ONLY the JSON, no explanations.

---

## üóÑÔ∏è –ü–†–ò–û–†–ò–¢–ï–¢ 2: Knowledge Base (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ samples)

### 1. `app/knowledge_base/B5_URS_KROS4/kros_sample.json`
```json
{
  "source": "KROS 4 (sample)",
  "positions": [
    {
      "code": "111-01-001",
      "name": "V√Ωkopy nezapa≈æen√©",
      "unit": "m¬≥",
      "category": "Zemn√≠ pr√°ce",
      "price_range": {
        "min": 150,
        "max": 300,
        "avg": 220
      }
    },
    {
      "code": "121-01-015",
      "name": "Betonov√© konstrukce monolitick√©",
      "unit": "m¬≥",
      "category": "Betonov√© pr√°ce",
      "price_range": {
        "min": 2200,
        "max": 2800,
        "avg": 2450
      }
    },
    {
      "code": "131-01-001",
      "name": "Zdivo z cihel p√°len√Ωch",
      "unit": "m¬≥",
      "category": "Zednick√© pr√°ce",
      "price_range": {
        "min": 3500,
        "max": 4500,
        "avg": 4000
      }
    },
    {
      "code": "141-01-001",
      "name": "Mont√°≈æ ocelov√Ωch konstrukc√≠",
      "unit": "t",
      "category": "Ocelov√© konstrukce",
      "price_range": {
        "min": 45000,
        "max": 65000,
        "avg": 55000
      }
    },
    {
      "code": "311-01-001",
      "name": "Om√≠tky vnit≈ôn√≠ v√°penn√©",
      "unit": "m¬≤",
      "category": "Dokonƒçovac√≠ pr√°ce",
      "price_range": {
        "min": 180,
        "max": 280,
        "avg": 230
      }
    }
  ]
}
