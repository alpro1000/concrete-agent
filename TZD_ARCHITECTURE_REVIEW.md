# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –û–±–∑–æ—Ä TZDReader –ê–≥–µ–Ω—Ç–∞

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2024-01-10  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** 2.0  
**–§–æ–∫—É—Å:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å TZDReader –∞–≥–µ–Ω—Ç–∞

---

## üìã –†–µ–∑—é–º–µ

TZDReader –∞–≥–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º —Å–∏—Å—Ç–µ–º—ã Construction Analysis API, –æ—Ç–≤–µ—á–∞—é—â–∏–º –∑–∞ –∞–Ω–∞–ª–∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏–π. –î–∞–Ω–Ω—ã–π –æ–±–∑–æ—Ä –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞, –≤—ã—è–≤–ª—è–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

### –û–±—â–∞—è –û—Ü–µ–Ω–∫–∞: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5)

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –•–æ—Ä–æ—à–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º LLM —Å–µ—Ä–≤–∏—Å–æ–º
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (GPT, Claude)

**–û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry-–ª–æ–≥–∏–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
- ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç—è—Ö
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ê–Ω–∞–ª–∏–∑

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### 1.1 –ú–æ–¥—É–ª—å–Ω–∞—è –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è ‚úÖ –•–û–†–û–®–û

```
agents/tzd_reader/
‚îú‚îÄ‚îÄ __init__.py          # –ü—É–±–ª–∏—á–Ω—ã–π API —Å –∫–ª–∞—Å—Å–æ–º TZDReader
‚îú‚îÄ‚îÄ agent.py             # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
‚îî‚îÄ‚îÄ security.py          # –í–∞–ª–∏–¥–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤
```

**–û—Ü–µ–Ω–∫–∞:** –û—Ç–ª–∏—á–Ω–∞—è
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –£–¥–æ–±–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π API —á–µ—Ä–µ–∑ `TZDReader` –∫–ª–∞—Å—Å
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∂–µ—Å—Ç–∫–æ–π —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
```
agents/tzd_reader/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ agent.py
‚îú‚îÄ‚îÄ security.py
‚îú‚îÄ‚îÄ exceptions.py        # [–ù–û–í–û–ï] –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ monitoring.py        # [–ù–û–í–û–ï] –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ validators.py        # [–ù–û–í–û–ï] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

#### 1.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¢–æ—á–∫–∏ ‚úÖ –•–û–†–û–®–û

**–¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**

1. **Router Layer** (`app/routers/tzd_router.py`)
   - FastAPI —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

2. **Orchestrator** (`app/core/orchestrator.py`)
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏

3. **LLM Service** (`app/core/llm_service.py`)
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å AI
   - –ú—É–ª—å—Ç–∏-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞–º–∏

**–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞:**
```
[Client Request]
      ‚Üì
[tzd_router.py] ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚Üí [FileSecurityValidator]
      ‚Üì
[tzd_reader()] ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí [DocParser/MinerU]
      ‚Üì
[SecureAIAnalyzer] ‚Üí –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM ‚Üí [LLMService]
      ‚Üì
[Response] ‚Üê –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Üê [normalize_diacritics]
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –†–æ—É—Ç–µ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤)
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–ª–æ–π —Å–µ—Ä–≤–∏—Å–æ–≤ –º–µ–∂–¥—É —Ä–æ—É—Ç–µ—Ä–æ–º –∏ –∞–≥–µ–Ω—Ç–æ–º
- ‚ùå –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `tzd_reader()` –∏–∑ —Ä–æ—É—Ç–µ—Ä–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π:
```python
# services/tzd_service.py
class TZDService:
    """–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–ª—è TZD –∞–Ω–∞–ª–∏–∑–∞"""
    
    def __init__(self):
        self.reader = TZDReader()
        self.validator = FileSecurityValidator()
    
    async def analyze_files(
        self, 
        files: List[UploadFile],
        engine: str = "auto"
    ) -> Dict[str, Any]:
        """–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞"""
        # –í–∞–ª–∏–¥–∞—Ü–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑, –æ—á–∏—Å—Ç–∫–∞
        pass
```

---

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫ ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –£–õ–£–ß–®–ï–ù–ò–Ø

#### 2.1 –¢–µ–∫—É—â–µ–µ –°–æ—Å—Ç–æ—è–Ω–∏–µ

**–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ:**
```python
# agent.py - –•–æ—Ä–æ—à–∞—è –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
try:
    combined_text = _process_files_with_parsers(files, base_dir)
    result = analyzer.analyze_with_gpt(combined_text)
except (ValueError, SecurityError) as e:
    raise e  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–∂–∏–¥–∞–µ–º—ã–µ –æ—à–∏–±–∫–∏
except Exception as e:
    logger.error(f"Critical error: {e}")
    return error_result  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π:**
```python
# –¢–µ–∫—É—â–∏–π –∫–æ–¥
raise ValueError("File list cannot be empty")

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å
class EmptyFileListError(TZDReaderError):
    """Raised when file list is empty"""
    pass

raise EmptyFileListError("File list cannot be empty")
```

2. **–ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏:**
```python
# agent.py:418 - –¢–µ—Ä—è–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
except Exception as e:
    logger.error(f"Critical error: {e}")
    error_result = SecureAIAnalyzer()._get_empty_result()
    error_result['critical_error'] = str(e)  # –¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∞
    return error_result
```

3. **–ù–µ—Ç retry-–ª–æ–≥–∏–∫–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤:**
```python
# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏ —Å–±–æ–µ AI API
result = analyzer.analyze_with_gpt(combined_text)
```

#### 2.2 –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –£–ª—É—á—à–µ–Ω–∏—é

**A. –ò–µ—Ä–∞—Ä—Ö–∏—è –ò—Å–∫–ª—é—á–µ–Ω–∏–π:**

```python
# agents/tzd_reader/exceptions.py
class TZDReaderError(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è TZDReader"""
    def __init__(self, message: str, details: Dict[str, Any] = None):
        self.message = message
        self.details = details or {}
        super().__init__(self.message)

class ValidationError(TZDReaderError):
    """–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    pass

class ParsingError(TZDReaderError):
    """–û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    pass

class AIServiceError(TZDReaderError):
    """–û—à–∏–±–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å AI —Å–µ—Ä–≤–∏—Å–æ–º"""
    pass

class TemporaryError(TZDReaderError):
    """–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–∞"""
    pass
```

**B. Retry-–ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –æ—Ç—Å—Ç—É–ø–æ–º:**

```python
from tenacity import (
    retry, 
    stop_after_attempt, 
    wait_exponential,
    retry_if_exception_type
)

class SecureAIAnalyzer:
    
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=4, max=10),
        retry=retry_if_exception_type(TemporaryError)
    )
    async def analyze_with_llm_service(
        self, 
        text: str, 
        provider: str = "claude"
    ) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏"""
        try:
            response = await self.llm_service.run_prompt(...)
            
            if not response.get("success"):
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞
                error_msg = response.get("error", "")
                if "rate limit" in error_msg.lower() or "timeout" in error_msg.lower():
                    raise TemporaryError(f"Temporary AI service error: {error_msg}")
                else:
                    raise AIServiceError(f"AI service error: {error_msg}")
            
            return result
            
        except TemporaryError:
            raise  # –ë—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
        except Exception as e:
            raise AIServiceError(f"Unexpected error: {e}")
```

**C. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```python
import structlog

logger = structlog.get_logger(__name__)

def tzd_reader(files: List[str], engine: str = "gpt", base_dir: Optional[str] = None):
    request_id = str(uuid.uuid4())
    
    log = logger.bind(
        request_id=request_id,
        files_count=len(files),
        engine=engine
    )
    
    log.info("tzd_analysis_started")
    
    try:
        result = _do_analysis(files, engine, base_dir)
        log.info(
            "tzd_analysis_completed",
            processed_files=result['processing_metadata']['processed_files'],
            duration=result['processing_metadata']['processing_time_seconds']
        )
        return result
        
    except ValidationError as e:
        log.error("validation_error", error=str(e), details=e.details)
        raise
    except AIServiceError as e:
        log.error("ai_service_error", error=str(e), details=e.details)
        raise
```

---

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å üîí –•–û–†–û–®–û, –ù–û –ú–û–ñ–ù–û –£–õ–£–ß–®–ò–¢–¨

#### 3.1 –¢–µ–∫—É—â–∏–µ –ú–µ—Ä—ã –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚úÖ

**–û—Ç–ª–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤** (`security.py`):
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (max 10MB)
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–æ–≤
   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç path traversal
   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç symlink –∞—Ç–∞–∫
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ magic bytes

2. **–ò–∑–æ–ª—è—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:**
```python
temp_dir = tempfile.mkdtemp(prefix="tzd_secure_")
# –§–∞–π–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:**
```python
if temp_dir.startswith('/tmp/'):  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    shutil.rmtree(temp_dir)
```

#### 3.2 –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –£–ª—É—á—à–µ–Ω–∏—è ‚ö†Ô∏è

**A. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Rate Limiting:**

```python
# –ü—Ä–æ–±–ª–µ–º–∞: –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
@router.post("/analyze")
async def analyze_tzd_documents(...):
    # –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç DoS
    pass
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@router.post("/analyze")
@limiter.limit("10/minute")  # 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
async def analyze_tzd_documents(request: Request, ...):
    pass
```

**B. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**

```python
# –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø
@router.post("/analyze")
async def analyze_tzd_documents(...):
    # –î–æ—Å—Ç—É–ø –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
from fastapi import Security, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def verify_api_key(
    credentials: HTTPAuthorizationCredentials = Security(security)
) -> str:
    api_key = os.getenv("TZD_API_KEY")
    if not api_key or credentials.credentials != api_key:
        raise HTTPException(
            status_code=401,
            detail="Invalid or missing API key"
        )
    return credentials.credentials

@router.post("/analyze", dependencies=[Depends(verify_api_key)])
async def analyze_tzd_documents(...):
    pass
```

**C. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ:**

```python
# security.py - –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
if header.startswith(b'%PDF'):
    return True
```

**–£–ª—É—á—à–µ–Ω–∏–µ:**
```python
def validate_pdf_structure(file_path: str) -> bool:
    """–ì–ª—É–±–æ–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è PDF —Å—Ç—Ä—É–∫—Ç—É—Ä—ã"""
    try:
        import PyPDF2
        with open(file_path, 'rb') as f:
            reader = PyPDF2.PdfReader(f)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            if reader.metadata:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                pass
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
            if len(reader.pages) > 100:
                raise SecurityError("PDF has too many pages")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            for page in reader.pages:
                if '/JS' in page or '/JavaScript' in page:
                    raise SecurityError("PDF contains JavaScript")
            
        return True
    except Exception as e:
        raise SecurityError(f"Invalid PDF structure: {e}")
```

**D. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**

```python
# agents/tzd_reader/monitoring.py
class SecurityAuditor:
    """–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π TZDReader"""
    
    def log_file_access(
        self,
        file_path: str,
        user_id: Optional[str],
        ip_address: str,
        operation: str
    ):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º"""
        audit_log = {
            'timestamp': datetime.utcnow().isoformat(),
            'file_path': file_path,
            'user_id': user_id,
            'ip_address': ip_address,
            'operation': operation,
            'agent': 'TZDReader'
        }
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞
        logger.info("security_audit", **audit_log)
    
    def check_suspicious_patterns(self, file_path: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ —Ñ–∞–π–ª–∞—Ö"""
        suspicious_patterns = [
            b'<script>',
            b'eval(',
            b'exec(',
            b'__import__'
        ]
        
        with open(file_path, 'rb') as f:
            content = f.read()
            for pattern in suspicious_patterns:
                if pattern in content:
                    self.log_security_event(
                        'suspicious_pattern_detected',
                        file_path=file_path,
                        pattern=pattern.decode('utf-8', errors='ignore')
                    )
                    return False
        return True
```

---

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å ‚ö†Ô∏è –°–†–ï–î–ù–ï

#### 4.1 –¢–µ–∫—É—â–∏–µ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**A. –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤:**
```python
# agent.py:311-344 - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
for file_path in files:
    try:
        text = doc_parser.parse(file_path)  # –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
        text_parts.append(text)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ 10 —Ñ–∞–π–ª–æ–≤ –ø–æ 1 —Å–µ–∫—É–Ω–¥–µ –∫–∞–∂–¥—ã–π = 10 —Å–µ–∫—É–Ω–¥ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
import asyncio
from concurrent.futures import ProcessPoolExecutor

async def _process_files_with_parsers_async(
    files: List[str], 
    base_dir: Optional[str] = None
) -> str:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"""
    
    validator = FileSecurityValidator()
    doc_parser = DocParser()
    
    async def process_single_file(file_path: str) -> Optional[str]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
            validator.validate_all(file_path, base_dir)
            
            # –ü–∞—Ä—Å–∏–Ω–≥ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ (CPU-bound)
            loop = asyncio.get_event_loop()
            with ProcessPoolExecutor() as executor:
                text = await loop.run_in_executor(
                    executor,
                    doc_parser.parse,
                    file_path
                )
            
            return normalize_diacritics(text) if text else None
            
        except Exception as e:
            logger.error(f"File processing error {file_path}: {e}")
            return None
    
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
    tasks = [process_single_file(f) for f in files]
    results = await asyncio.gather(*tasks)
    
    # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    text_parts = []
    for i, text in enumerate(results):
        if text and text.strip():
            file_header = f"\n=== File: {Path(files[i]).name} ===\n"
            text_parts.extend([file_header, text, "\n"])
    
    return ''.join(text_parts)
```

**B. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
```python
# –ö–∞–∂–¥—ã–π –∞–Ω–∞–ª–∏–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ, –¥–∞–∂–µ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
result = tzd_reader(files=file_paths, engine=ai_engine)
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
import hashlib
from functools import lru_cache

class TZDCache:
    """–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞"""
    
    def __init__(self, max_size: int = 100):
        self._cache = {}
        self._max_size = max_size
    
    def get_file_hash(self, file_path: str) -> str:
        """–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–∞ —Ñ–∞–π–ª–∞"""
        hasher = hashlib.sha256()
        with open(file_path, 'rb') as f:
            for chunk in iter(lambda: f.read(4096), b""):
                hasher.update(chunk)
        return hasher.hexdigest()
    
    def get_cache_key(self, files: List[str], engine: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫–µ—à–∞"""
        file_hashes = [self.get_file_hash(f) for f in files]
        combined = f"{','.join(sorted(file_hashes))}:{engine}"
        return hashlib.sha256(combined.encode()).hexdigest()
    
    def get(self, files: List[str], engine: str) -> Optional[Dict[str, Any]]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞"""
        cache_key = self.get_cache_key(files, engine)
        return self._cache.get(cache_key)
    
    def set(self, files: List[str], engine: str, result: Dict[str, Any]):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à"""
        if len(self._cache) >= self._max_size:
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–µ–π—à–∏–π —ç–ª–µ–º–µ–Ω—Ç (–ø—Ä–æ—Å—Ç–∞—è FIFO —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)
            self._cache.pop(next(iter(self._cache)))
        
        cache_key = self.get_cache_key(files, engine)
        self._cache[cache_key] = result

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
cache = TZDCache()

def tzd_reader(files: List[str], engine: str = "gpt", base_dir: Optional[str] = None):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
    cached_result = cache.get(files, engine)
    if cached_result:
        logger.info("Using cached result")
        cached_result['from_cache'] = True
        return cached_result
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
    result = _do_analysis(files, engine, base_dir)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
    cache.set(files, engine, result)
    
    return result
```

**C. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

```python
# agents/tzd_reader/monitoring.py
from dataclasses import dataclass
from typing import Dict, Any
import time

@dataclass
class PerformanceMetrics:
    """–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    operation: str
    duration_seconds: float
    files_processed: int
    total_text_length: int
    ai_provider: str
    success: bool
    error: Optional[str] = None

class PerformanceMonitor:
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ TZDReader"""
    
    def __init__(self):
        self.metrics: List[PerformanceMetrics] = []
    
    def track_operation(self, operation: str):
        """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π"""
        def decorator(func):
            @functools.wraps(func)
            def wrapper(*args, **kwargs):
                start_time = time.time()
                success = False
                error = None
                
                try:
                    result = func(*args, **kwargs)
                    success = True
                    return result
                except Exception as e:
                    error = str(e)
                    raise
                finally:
                    duration = time.time() - start_time
                    
                    metric = PerformanceMetrics(
                        operation=operation,
                        duration_seconds=duration,
                        files_processed=len(args[0]) if args else 0,
                        total_text_length=0,  # –û–±–Ω–æ–≤–∏—Ç—å –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                        ai_provider=kwargs.get('engine', 'unknown'),
                        success=success,
                        error=error
                    )
                    
                    self.metrics.append(metric)
                    self._log_metric(metric)
            
            return wrapper
        return decorator
    
    def _log_metric(self, metric: PerformanceMetrics):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏"""
        logger.info(
            "performance_metric",
            operation=metric.operation,
            duration=metric.duration_seconds,
            files=metric.files_processed,
            success=metric.success,
            error=metric.error
        )
    
    def get_statistics(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        if not self.metrics:
            return {}
        
        successful = [m for m in self.metrics if m.success]
        failed = [m for m in self.metrics if not m.success]
        
        return {
            'total_operations': len(self.metrics),
            'successful_operations': len(successful),
            'failed_operations': len(failed),
            'avg_duration_seconds': sum(m.duration_seconds for m in successful) / len(successful) if successful else 0,
            'max_duration_seconds': max(m.duration_seconds for m in self.metrics),
            'total_files_processed': sum(m.files_processed for m in successful)
        }
```

---

### 5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ üîç –¢–†–ï–ë–£–ï–¢ –£–õ–£–ß–®–ï–ù–ò–Ø

#### 5.1 –¢–µ–∫—É—â–µ–µ –°–æ—Å—Ç–æ—è–Ω–∏–µ

**–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ:**
```python
logger.info(f"Processing file: {Path(file_path).name}")
logger.error(f"File processing error {file_path}: {e}")
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ correlation ID –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –ù–µ—Ç —É—Ä–æ–≤–Ω–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (DEBUG, INFO, WARNING, ERROR)
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### 5.2 –£–ª—É—á—à–µ–Ω–Ω–æ–µ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**A. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```python
# utils/logging_config.py
import structlog
import logging.config

def setup_structured_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    logging.config.dictConfig({
        "version": 1,
        "disable_existing_loggers": False,
        "formatters": {
            "json": {
                "()": structlog.stdlib.ProcessorFormatter,
                "processor": structlog.processors.JSONRenderer(),
            },
        },
        "handlers": {
            "console": {
                "class": "logging.StreamHandler",
                "formatter": "json",
            },
            "file": {
                "class": "logging.handlers.RotatingFileHandler",
                "filename": "logs/tzd_reader.log",
                "maxBytes": 10485760,  # 10MB
                "backupCount": 5,
                "formatter": "json",
            },
        },
        "loggers": {
            "agents.tzd_reader": {
                "handlers": ["console", "file"],
                "level": "INFO",
            },
        },
    })
    
    structlog.configure(
        processors=[
            structlog.stdlib.filter_by_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.add_log_level,
            structlog.stdlib.PositionalArgumentsFormatter(),
            structlog.processors.TimeStamper(fmt="iso"),
            structlog.processors.StackInfoRenderer(),
            structlog.processors.format_exc_info,
            structlog.processors.UnicodeDecoder(),
            structlog.stdlib.ProcessorFormatter.wrap_for_formatter,
        ],
        context_class=dict,
        logger_factory=structlog.stdlib.LoggerFactory(),
        cache_logger_on_first_use=True,
    )

# agents/tzd_reader/agent.py
import structlog
logger = structlog.get_logger(__name__)

def tzd_reader(files: List[str], engine: str = "gpt", base_dir: Optional[str] = None):
    request_id = str(uuid.uuid4())
    
    log = logger.bind(
        request_id=request_id,
        component="tzd_reader",
        files_count=len(files),
        engine=engine
    )
    
    log.info(
        "analysis_started",
        files=[Path(f).name for f in files]
    )
    
    try:
        # ... processing ...
        
        log.info(
            "analysis_completed",
            duration=duration,
            processed_files=len(processed),
            ai_model=result.get('ai_model')
        )
        
    except Exception as e:
        log.error(
            "analysis_failed",
            error=str(e),
            error_type=type(e).__name__,
            exc_info=True
        )
        raise
```

**B. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```python
# agents/tzd_reader/monitoring.py
from prometheus_client import Counter, Histogram, Gauge
import time

# –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
tzd_requests_total = Counter(
    'tzd_requests_total',
    'Total number of TZD analysis requests',
    ['engine', 'status']
)

tzd_processing_duration = Histogram(
    'tzd_processing_duration_seconds',
    'Time spent processing TZD requests',
    ['engine']
)

tzd_files_processed = Counter(
    'tzd_files_processed_total',
    'Total number of files processed',
    ['file_type']
)

tzd_active_requests = Gauge(
    'tzd_active_requests',
    'Number of active TZD requests'
)

class MetricsCollector:
    """–°–±–æ—Ä—â–∏–∫ –º–µ—Ç—Ä–∏–∫ –¥–ª—è TZDReader"""
    
    @staticmethod
    def track_request(engine: str):
        """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞"""
        tzd_active_requests.inc()
        start_time = time.time()
        
        try:
            yield
            tzd_requests_total.labels(engine=engine, status='success').inc()
        except Exception:
            tzd_requests_total.labels(engine=engine, status='error').inc()
            raise
        finally:
            duration = time.time() - start_time
            tzd_processing_duration.labels(engine=engine).observe(duration)
            tzd_active_requests.dec()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
def tzd_reader(files: List[str], engine: str = "gpt", base_dir: Optional[str] = None):
    with MetricsCollector.track_request(engine):
        # ... processing ...
        
        for file_path in files:
            file_type = Path(file_path).suffix
            tzd_files_processed.labels(file_type=file_type).inc()
```

**C. Health Check —ç–Ω–¥–ø–æ–∏–Ω—Ç:**

```python
# app/routers/tzd_router.py
@router.get("/health/detailed")
async def detailed_health_check():
    """–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã"""
    
    health_status = {
        "service": "TZD Reader",
        "timestamp": datetime.utcnow().isoformat(),
        "status": "healthy",
        "checks": {}
    }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞
    try:
        from agents.tzd_reader.agent import tzd_reader
        health_status["checks"]["tzd_agent"] = {"status": "available"}
    except ImportError as e:
        health_status["checks"]["tzd_agent"] = {
            "status": "unavailable",
            "error": str(e)
        }
        health_status["status"] = "degraded"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ LLM —Å–µ—Ä–≤–∏—Å–∞
    try:
        from app.core.llm_service import get_llm_service
        llm = get_llm_service()
        providers = llm.get_available_providers()
        health_status["checks"]["llm_service"] = {
            "status": "available",
            "providers": providers
        }
    except Exception as e:
        health_status["checks"]["llm_service"] = {
            "status": "unavailable",
            "error": str(e)
        }
        health_status["status"] = "degraded"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
    try:
        temp_dir = tempfile.mkdtemp(prefix="health_check_")
        test_file = os.path.join(temp_dir, "test.txt")
        with open(test_file, 'w') as f:
            f.write("test")
        os.remove(test_file)
        os.rmdir(temp_dir)
        health_status["checks"]["filesystem"] = {"status": "writable"}
    except Exception as e:
        health_status["checks"]["filesystem"] = {
            "status": "error",
            "error": str(e)
        }
        health_status["status"] = "unhealthy"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏
    import psutil
    memory = psutil.virtual_memory()
    health_status["checks"]["memory"] = {
        "status": "ok" if memory.percent < 90 else "warning",
        "used_percent": memory.percent,
        "available_mb": memory.available / (1024 * 1024)
    }
    
    return health_status
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –£–ª—É—á—à–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (–í–Ω–µ–¥—Ä–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. **–î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è API** üîí
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API key –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
   - –î–æ–±–∞–≤–∏—Ç—å rate limiting
   - –í–Ω–µ–¥—Ä–∏—Ç—å –∞—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–∞

2. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** ‚ö†Ô∏è
   - –°–æ–∑–¥–∞—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é –∏—Å–∫–ª—é—á–µ–Ω–∏–π
   - –î–æ–±–∞–≤–∏—Ç—å retry-–ª–æ–≥–∏–∫—É
   - –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

3. **–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** üìä
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å structlog
   - –î–æ–±–∞–≤–∏—Ç—å correlation ID
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í–´–°–û–ö–ò–ô (–í–Ω–µ–¥—Ä–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –Ω–µ–¥–µ–ª—å)

4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚ö°
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

5. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** üìà
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - Alerts –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π

6. **–£–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** üß™
   - –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
   - –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –°–†–ï–î–ù–ò–ô (–í–Ω–µ–¥—Ä–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞)

7. **–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π** üèóÔ∏è
   - –û—Ç–¥–µ–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –æ—Ç —Ä–æ—É—Ç–µ—Ä–æ–≤
   - –£–ª—É—á—à–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é —á–∏—Å—Ç–æ—Ç—É
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

8. **–†–∞—Å—à–∏—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** üõ°Ô∏è
   - –ì–ª—É–±–æ–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PDF
   - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è DOCX

9. **–£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** üìö
   - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üìà –ü–ª–∞–Ω –í–Ω–µ–¥—Ä–µ–Ω–∏—è

### –ù–µ–¥–µ–ª—è 1-2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –£–ª—É—á—à–µ–Ω–∏—è

```python
# 1. –°–æ–∑–¥–∞—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é –∏—Å–∫–ª—é—á–µ–Ω–∏–π
touch agents/tzd_reader/exceptions.py

# 2. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
pip install structlog
# –û–±–Ω–æ–≤–∏—Ç—å logging_config.py

# 3. –î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
# –û–±–Ω–æ–≤–∏—Ç—å tzd_router.py —Å API key auth

# 4. –î–æ–±–∞–≤–∏—Ç—å retry-–ª–æ–≥–∏–∫—É
pip install tenacity
# –û–±–Ω–æ–≤–∏—Ç—å agent.py —Å retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏
```

### –ù–µ–¥–µ–ª—è 3-4: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```python
# 5. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ _process_files_with_parsers

# 6. –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
# –°–æ–∑–¥–∞—Ç—å TZDCache –∫–ª–∞—Å—Å

# 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus
pip install prometheus-client
touch agents/tzd_reader/monitoring.py

# 8. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
# –û–±–Ω–æ–≤–∏—Ç—å agent.py —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
```

### –ù–µ–¥–µ–ª—è 5-6: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –£–ª—É—á—à–µ–Ω–∏—è

```python
# 9. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π
mkdir services
touch services/tzd_service.py

# 10. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Ä–æ—É—Ç–µ—Ä–∞
# –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ TZDService

# 11. –£–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç—ã
# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

# 12. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
# –û–±–Ω–æ–≤–∏—Ç—å TZD_READER_README.md
```

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –£–ª—É—á—à–µ–Ω–∏—è

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
tail -f logs/tzd_reader.log | jq

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫
curl http://localhost:8000/metrics | grep tzd_

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl http://localhost:8000/api/v1/tzd/health/detailed | jq
```

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏–∑

- üìä –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üêõ –û–±–∑–æ—Ä –æ—à–∏–±–æ–∫ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- üìà –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π

### –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –û–±–∑–æ—Ä

- üéØ –û—Ü–µ–Ω–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
- üìö –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- üß™ –†–µ–≤–∏–∑–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –£—Å–ø–µ—Ö–∞

–°–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π, –∫–æ–≥–¥–∞:

1. **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** >= 99.5%
2. **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞** < 5 —Å–µ–∫—É–Ω–¥
3. **–ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫** < 1%
4. **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏** >= 80%
5. **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è** < 5 –º–∏–Ω—É—Ç

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [SECURITY_ARCHITECTURE_ANALYSIS.md](./SECURITY_ARCHITECTURE_ANALYSIS.md)
- [MODULAR_ARCHITECTURE.md](./MODULAR_ARCHITECTURE.md)
- [TZD_READER_README.md](./TZD_READER_README.md)

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- [structlog](https://www.structlog.org/) - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [tenacity](https://tenacity.readthedocs.io/) - Retry-–ª–æ–≥–∏–∫–∞
- [prometheus-client](https://github.com/prometheus/client_python) - –ú–µ—Ç—Ä–∏–∫–∏
- [slowapi](https://github.com/laurentS/slowapi) - Rate limiting

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** AI Architect  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024-01-10
