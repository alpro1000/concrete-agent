# Решение проблемы 422 Unprocessable Entity

## 1. Исправление ошибки

### Причина ошибки
Несоответствие между структурой данных, отправляемых фронтендом, и ожидаемыми параметрами на бэкенде:

**Фронтенд отправлял:**
```javascript
formData.append('technical_files', file);
formData.append('quantities_files', file);
formData.append('drawings_files', file);
```

**Бэкенд ожидал:**
```python
async def analyze_files(files: List[UploadFile] = File(...))
```

### Решение
Обновлена сигнатура endpoint'а для соответствия структуре FormData:

```python
@router.post("/unified")
async def analyze_files(
    technical_files: Optional[List[UploadFile]] = File(None),
    quantities_files: Optional[List[UploadFile]] = File(None),
    drawings_files: Optional[List[UploadFile]] = File(None)
):
```

## 2. Структура FormData - Лучшие практики

### ✅ Правильная структура (теперь используется)

```javascript
const formData = new FormData();

// Добавление файлов с правильными именами полей
technicalFiles.forEach(file => {
  formData.append('technical_files', file);
});
quantitiesFiles.forEach(file => {
  formData.append('quantities_files', file);
});
drawingsFiles.forEach(file => {
  formData.append('drawings_files', file);
});
```

### Ключевые моменты:

1. **Имена полей должны точно соответствовать параметрам бэкенда**
   - `technical_files` → `technical_files: Optional[List[UploadFile]]`
   - `quantities_files` → `quantities_files: Optional[List[UploadFile]]`
   - `drawings_files` → `drawings_files: Optional[List[UploadFile]]`

2. **Множественные файлы в одном поле**
   - Используйте одно и то же имя поля для нескольких файлов
   - FastAPI автоматически создаст список

3. **Не устанавливайте Content-Type вручную**
   - Браузер автоматически установит `multipart/form-data` с boundary
   - Axios может удалить заголовок, если вы установите его вручную

## 3. Проверка обязательных полей

### Текущая валидация

**На фронтенде:**
```typescript
const totalFiles = technicalFiles.length + quantitiesFiles.length + drawingsFiles.length;

if (totalFiles === 0) {
  message.warning(t('validation.fileRequired'));
  return;
}
```

**На бэкенде:**
```python
if not all_files:
    raise HTTPException(status_code=400, detail="No files uploaded")
```

### Валидация расширений файлов

```python
ALLOWED_EXTENSIONS = {
    '.pdf', '.docx', '.txt',      # Technical documents
    '.xlsx', '.xls', '.xml', '.xc4',  # Quantities
    '.dwg', '.dxf', '.png', '.jpg', '.jpeg'  # Drawings
}

ext = os.path.splitext(file.filename)[1].lower()
if ext not in ALLOWED_EXTENSIONS:
    file_result["error"] = f"Invalid extension: {ext}"
```

### Валидация размера файла

```python
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50 MB

if len(content) > MAX_FILE_SIZE:
    file_result["error"] = f"File too large: {len(content)} bytes (max 50MB)"
```

## 4. Правильные заголовки запроса

### ❌ Неправильно
```typescript
const response = await apiClient.post('/api/v1/analysis/unified', formData, {
  headers: {
    'Content-Type': 'multipart/form-data',  // НЕ УСТАНАВЛИВАЙТЕ ВРУЧНУЮ
  }
});
```

### ✅ Правильно
```typescript
const response = await apiClient.post('/api/v1/analysis/unified', formData);
// Axios автоматически установит правильные заголовки для FormData
```

Или, если нужен таймаут:
```typescript
const response = await apiClient.post('/api/v1/analysis/unified', formData, {
  timeout: 300000, // 5 минут
});
```

**Причина:** Когда вы передаете FormData, Axios автоматически:
1. Устанавливает `Content-Type: multipart/form-data`
2. Добавляет boundary для разделения полей
3. Удаляет заголовок, если вы установили его вручную (без boundary)

## 5. Лучшие практики предотвращения ошибок 422

### 1. Валидация на клиенте
```typescript
const beforeUpload = (file: RcFile, panelType: string): boolean => {
  // Проверка размера
  if (file.size > MAX_SIZE) {
    message.error('File too large');
    return false;
  }
  
  // Проверка расширения
  const ext = '.' + file.name.split('.').pop()?.toLowerCase();
  if (!ALLOWED_EXTENSIONS.includes(ext)) {
    message.error('Invalid file type');
    return false;
  }
  
  return true;
};
```

### 2. Использование TypeScript интерфейсов
```typescript
interface AnalysisRequest {
  technical_files?: File[];
  quantities_files?: File[];
  drawings_files?: File[];
}
```

### 3. Логирование запросов
```typescript
console.log('Sending files:', {
  technical: technicalFiles.length,
  quantities: quantitiesFiles.length,
  drawings: drawingsFiles.length
});
```

### 4. Обработка ошибок
```typescript
if (error.response) {
  const { status, data } = error.response;
  
  switch (status) {
    case 400:
      message.error(data?.detail || 'Validation error');
      break;
    case 422:
      message.error(data?.detail || 'Invalid request format');
      console.error('422 Details:', data);
      break;
    case 500:
      message.error('Server error');
      break;
  }
}
```

## 6. Инструменты проверки API

### 1. FastAPI Automatic Documentation

После запуска сервера:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

Документация показывает:
- Ожидаемые параметры
- Типы данных
- Примеры запросов/ответов

### 2. Python Pydantic Validation

FastAPI использует Pydantic для автоматической валидации:
```python
from pydantic import BaseModel, validator

class FileUploadRequest(BaseModel):
    technical_files: Optional[List[UploadFile]] = None
    
    @validator('technical_files')
    def validate_files(cls, v):
        if v:
            for file in v:
                # Custom validation
                pass
        return v
```

### 3. TypeScript Type Checking

```typescript
// frontend/src/types/api.ts
export interface AnalysisResult {
  status: 'success' | 'error' | 'partial';
  message?: string;
  files: FileResult[];
  summary: {
    total: number;
    successful: number;
    failed: number;
  };
}
```

### 4. Automated Testing

```python
# tests/test_unified_endpoint.py
def test_upload_files():
    files = {
        'technical_files': ('test.pdf', io.BytesIO(b'content'), 'application/pdf')
    }
    response = client.post('/api/v1/analysis/unified', files=files)
    assert response.status_code == 200
```

## 7. Результаты тестирования

### Все тесты пройдены ✅

```
TEST 1: Multiple files from all panels - ✅ PASSED
TEST 2: Only technical files (partial upload) - ✅ PASSED
TEST 3: Invalid file type (should fail gracefully) - ✅ PASSED
TEST 4: Empty request (should return 400) - ✅ PASSED
TEST 5: Mixed file extensions - ✅ PASSED
```

### Проверено:
- ✅ Нет ошибки 422
- ✅ Файлы правильно категоризируются
- ✅ Валидация расширений работает
- ✅ Валидация размера работает
- ✅ Частичный успех обрабатывается корректно
- ✅ Пустой запрос возвращает 400

## 8. Команды для проверки

### Запуск сервера
```bash
cd /home/runner/work/concrete-agent/concrete-agent
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### Тестирование с curl
```bash
# Создать тестовые файлы
echo "test" > /tmp/test.pdf
echo "test" > /tmp/test.xlsx

# Отправить запрос
curl -X POST http://localhost:8000/api/v1/analysis/unified \
  -F "technical_files=@/tmp/test.pdf" \
  -F "quantities_files=@/tmp/test.xlsx"
```

### Запуск автоматических тестов
```bash
python /tmp/test_integration.py
```

## Заключение

Проблема 422 была вызвана несоответствием между клиентом и сервером. Решение включает:

1. ✅ Обновление сигнатуры endpoint'а
2. ✅ Добавление категоризации файлов
3. ✅ Улучшенная обработка ошибок
4. ✅ Комплексное тестирование

Теперь система полностью функциональна и соответствует документации.
