name: Deploy Frontend to Render

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Deploy to Render
        run: |
          echo "Triggering Render frontend deploy..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
               "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
               -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
               -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response body: $body"
          echo "HTTP status code: $http_code"
          
          if [ "$http_code" -ne 201 ] && [ "$http_code" -ne 200 ]; then
            echo "Deploy trigger failed with status $http_code"
            exit 1
          fi
          
          echo "Deploy triggered successfully"

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30
          
          echo "Checking if frontend is accessible..."
          for i in {1..10}; do
            if curl -f -s -o /dev/null -w "%{http_code}" "https://stav-agent.onrender.com" | grep -q "200\|301\|302"; then
              echo "Frontend is accessible!"
              exit 0
            fi
            echo "Attempt $i/10 failed, waiting 10 seconds..."
            sleep 10
          done
          
          echo "Warning: Frontend verification timed out, but deploy may still succeed"
          exit 0
