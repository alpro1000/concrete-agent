name: Update KB Metadata

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ… Ð² Knowledge Base
on:
  push:
    paths:
      - 'app/knowledge_base/**'
      - '!app/knowledge_base/**/metadata.json'  # ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐµÑÐ»Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ metadata.json Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ
    branches:
      - main

  # Ð˜Ð»Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ GitHub
  workflow_dispatch:

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ¤– Auto-generate metadata.json
        run: |
          echo "ðŸ”„ Updating metadata.json for all categories..."
          
          KB_DIR="app/knowledge_base"
          updated=0
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
          for category_path in $KB_DIR/B*; do
            if [ ! -d "$category_path" ]; then
              continue
            fi
            
            category=$(basename "$category_path")
            
            # Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
            file_count=$(find "$category_path" -type f \
              ! -name "metadata.json" \
              ! -name ".gitkeep" \
              ! -name ".DS_Store" 2>/dev/null | wc -l)
            
            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
            if [[ "$category" == *"price"* ]] || [[ "$category" == "B3_current_prices" ]]; then
              quarter=$(( ($(date +%-m) - 1) / 3 + 1 ))
              version="Q${quarter}_$(date +%Y)"
            else
              version="$(date +%Y.%m)"
            fi
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ metadata.json
            cat > "$category_path/metadata.json" << EOF
          {
            "category": "$category",
            "last_updated": "$(date +%Y-%m-%d)",
            "version": "$version",
            "source": "Auto-generated by GitHub Actions",
            "files": [],
            "notes": "Category has $file_count files. Auto-generated on $(date '+%Y-%m-%d %H:%M:%S UTC').",
            "auto_updated": true
          }
          EOF
            
            echo "âœ… Updated: $category (files: $file_count, version: $version)"
            ((updated++))
          done
          
          echo ""
          echo "âœ¨ Total updated: $updated categories"
      
      - name: ðŸ“ Check for changes
        id: check_changes
        run: |
          git diff --quiet app/knowledge_base/**/metadata.json || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ’¾ Commit and push
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add app/knowledge_base/**/metadata.json
          git commit -m "ðŸ¤– Auto-update KB metadata.json [skip ci]"
          git push
          
          echo "âœ… Changes committed and pushed!"
      
      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ“‹ Knowledge Base Metadata Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All metadata.json files have been updated automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Updated categories:**" >> $GITHUB_STEP_SUMMARY
          
          for category in app/knowledge_base/B*; do
            if [ -d "$category" ]; then
              cat_name=$(basename "$category")
              file_count=$(find "$category" -type f \
                ! -name "metadata.json" \
                ! -name ".gitkeep" \
                ! -name ".DS_Store" 2>/dev/null | wc -l)
              echo "- **$cat_name**: $file_count files" >> $GITHUB_STEP_SUMMARY
            fi
          done
