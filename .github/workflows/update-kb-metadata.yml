name: Update KB Metadata

# Запускается автоматически при изменениях в Knowledge Base
on:
  push:
    paths:
      - 'app/knowledge_base/**'
      - '!app/knowledge_base/**/metadata.json'  # Не запускать если только metadata.json изменился
    branches:
      - main

  # Или запустить вручную через веб-интерфейс GitHub
  workflow_dispatch:

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: 🤖 Auto-generate metadata.json
        run: |
          echo "🔄 Updating metadata.json for all categories..."
          
          KB_DIR="app/knowledge_base"
          updated=0
          
          # Обновляем все категории
          for category_path in $KB_DIR/B*; do
            if [ ! -d "$category_path" ]; then
              continue
            fi
            
            category=$(basename "$category_path")
            
            # Считаем файлы
            file_count=$(find "$category_path" -type f \
              ! -name "metadata.json" \
              ! -name ".gitkeep" \
              ! -name ".DS_Store" 2>/dev/null | wc -l)
            
            # Определяем версию
            if [[ "$category" == *"price"* ]] || [[ "$category" == "B3_current_prices" ]]; then
              quarter=$(( ($(date +%-m) - 1) / 3 + 1 ))
              version="Q${quarter}_$(date +%Y)"
            else
              version="$(date +%Y.%m)"
            fi
            
            # Создаем metadata.json
            cat > "$category_path/metadata.json" << EOF
          {
            "category": "$category",
            "last_updated": "$(date +%Y-%m-%d)",
            "version": "$version",
            "source": "Auto-generated by GitHub Actions",
            "files": [],
            "notes": "Category has $file_count files. Auto-generated on $(date '+%Y-%m-%d %H:%M:%S UTC').",
            "auto_updated": true
          }
          EOF
            
            echo "✅ Updated: $category (files: $file_count, version: $version)"
            ((updated++))
          done
          
          echo ""
          echo "✨ Total updated: $updated categories"
      
      - name: 📝 Check for changes
        id: check_changes
        run: |
          git diff --quiet app/knowledge_base/**/metadata.json || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: 💾 Commit and push
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add app/knowledge_base/**/metadata.json
          git commit -m "🤖 Auto-update KB metadata.json [skip ci]"
          git push
          
          echo "✅ Changes committed and pushed!"
      
      - name: 📊 Summary
        run: |
          echo "## 📋 Knowledge Base Metadata Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All metadata.json files have been updated automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Updated categories:**" >> $GITHUB_STEP_SUMMARY
          
          for category in app/knowledge_base/B*; do
            if [ -d "$category" ]; then
              cat_name=$(basename "$category")
              file_count=$(find "$category" -type f \
                ! -name "metadata.json" \
                ! -name ".gitkeep" \
                ! -name ".DS_Store" 2>/dev/null | wc -l)
              echo "- **$cat_name**: $file_count files" >> $GITHUB_STEP_SUMMARY
            fi
          done
