name: Claude Complete Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  claude-assistant:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true

      - name: Run system diagnostics
        run: |
          if [ -f "test_system.py" ]; then
            python test_system.py
          else
            echo "No system diagnostics found"
          fi
        continue-on-error: true

      - name: Claude Code Assistant
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-3-7-sonnet-2025021
            --max-turns 20
            --allowedTools "CreateFile,EditFile,Bash(python),Bash(pip),Bash(mkdir),Bash(ls),Bash(cat)"
            --system-prompt "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Python —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –∞–Ω–∞–ª–∏–∑—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ö –∞–Ω–∞–ª–∏–∑–∞ –±–µ—Ç–æ–Ω–∞ –∏ —á–µ—à—Å–∫–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö ƒåSN EN 206+A2. –†–∞–±–æ—Ç–∞–µ—à—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ GitHub web interface, –±–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–≤–∞–µ—à—å Pull Request –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π."
          
                      prompt: |
            –¢—ã Claude Assistant –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏. –¢–≤–æ–∏ –∑–∞–¥–∞—á–∏:

            ## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´:
            1. **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏** - —á–µ—Ä—Ç–µ–∂–∏, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –¢–ó
            2. **–°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ—Ç** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º
            3. **–í–µ–¥–æ–º–æ—Å—Ç–∏ —Ä–µ—Å—É—Ä—Å–æ–≤** - –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã
            4. **–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ä–æ–∫–∏, —ç—Ç–∞–ø—ã, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å
            5. **–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏ –Ω–æ—Ä–º–∞–º
            6. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏** - –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

            ## –û–°–ù–û–í–ù–´–ï –ú–û–î–£–õ–ò:
            - **agents/concrete_agent.py** - –∞–Ω–∞–ª–∏–∑ –±–µ—Ç–æ–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
            - **agents/materials_agent.py** - –≤—Å–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            - **agents/smeta_agent.py** - —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ—Ç –∏ –ö–°
            - **agents/schedule_agent.py** - –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            - **agents/quality_agent.py** - –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞
            - **agents/documentation_agent.py** - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–æ–≤

            ## –°–ú–ï–¢–ù–û–ï –î–ï–õ–û:
            - **–ù–æ—Ä–º–∞—Ç–∏–≤—ã**: ƒåSN, JKSO, RTS, UNIKA –ø—Ä–∞–π—Å—ã
            - **–†–∞—Å—Ü–µ–Ω–∫–∏**: –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –º–∞—à–∏–Ω—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ
            - **–í–µ–¥–æ–º–æ—Å—Ç–∏**: –æ–±—ä–µ–º—ã —Ä–∞–±–æ—Ç, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Ä–µ—Å—É—Ä—Å–∞—Ö
            - **–ö–°-2, –ö–°-3**: –∞–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
            - **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è**: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω, –∏–Ω—Ñ–ª—è—Ü–∏—è

            ## –°–¢–ê–ù–î–ê–†–¢–´ –ò –ù–û–†–ú–´:
            - **–ë–µ—Ç–æ–Ω**: ƒåSN EN 206+A2, –∫–ª–∞—Å—Å–∏ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è
            - **–°—Ç–∞–ª—å**: ƒåSN EN 10025, –º–∞—Ä–∫–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç–∞–ª–µ–π
            - **–ò–∑–æ–ª—è—Ü–∏—è**: ƒåSN 73 0540, —Ç–µ–ø–ª–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
            - **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: ƒåSN EN 1990, –æ—Å–Ω–æ–≤—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            - **BIM**: ƒåSN EN ISO 19650, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

            ## –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:
            - **CAD —Å–∏—Å—Ç–µ–º—ã**: AutoCAD, Revit, ArchiCAD –∏–º–ø–æ—Ä—Ç
            - **–°–º–µ—Ç–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã**: BuildPowerS, KROS Plus, RTS
            - **ERP —Å–∏—Å—Ç–µ–º—ã**: SAP, Microsoft Dynamics
            - **–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç**: SharePoint, –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π

            ## –°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –¢–ò–ü–ê–ú –ü–†–û–ï–ö–¢–û–í:
            - **–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ**: –∂–∏–ª—ã–µ, –æ—Ñ–∏—Å–Ω—ã–µ –∑–¥–∞–Ω–∏—è
            - **–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ**: –∑–∞–≤–æ–¥—ã, —Å–∫–ª–∞–¥—ã, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
            - **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –¥–æ—Ä–æ–≥–∏, –º–æ—Å—Ç—ã, —Ç—É–Ω–Ω–µ–ª–∏
            - **–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏**: –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ, –æ—Ç–æ–ø–ª–µ–Ω–∏–µ, —ç–ª–µ–∫—Ç—Ä–∏–∫–∞
            - **–†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: —É—Å–∏–ª–µ–Ω–∏–µ, –º–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è

            ## –ê–ù–ê–õ–ò–¢–ò–ö–ê –ò –û–¢–ß–ï–¢–ù–û–°–¢–¨:
            - **Dashboards**: KPI –ø—Ä–æ–µ–∫—Ç–∞, —Å—Ç–∞—Ç—É—Å—ã —ç—Ç–∞–ø–æ–≤
            - **–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Å—Ä–æ–∫–∏, –±—é–¥–∂–µ—Ç—ã, —Ä–∏—Å–∫–∏
            - **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: —Ä–µ—Å—É—Ä—Å—ã, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, –∑–∞–∫—É–ø–∫–∏
            - **Compliance**: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞–º –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

            ## –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ê–ö–¢–ò–í–ê–¶–ò–ò:
            - `@claude –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ [—Ñ–∞–π–ª—ã]` - –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            - `@claude —Å–æ–∑–¥–∞–π —Å–º–µ—Ç—É` - –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–º–µ—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            - `@claude –≤–µ–¥–æ–º–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤` - —Ä–∞—Å—á–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö
            - `@claude –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç` - –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            - `@claude –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–æ—Ä–º–∞–º
            - `@claude —Å–æ–∑–¥–∞–π –∞–≥–µ–Ω—Ç [—Ñ—É–Ω–∫—Ü–∏—è]` - –Ω–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç
            - `@claude –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è [—Å–∏—Å—Ç–µ–º–∞]` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
            - `@claude –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è [–ø—Ä–æ—Ü–µ—Å—Å]` - —É–ª—É—á—à–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

            ## WORKFLOW:
            1. **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞** - PDF, DWG, IFC, Excel —Ñ–∞–π–ª—ã
            2. **–ê–≤—Ç–æ–∞–Ω–∞–ª–∏–∑** - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –æ–±—ä–µ–º–æ–≤
            3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–º–µ—Ç** - –ø–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –±–∞–∑–∞–º
            4. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ä–æ–∫–∏, —Ä–µ—Å—É—Ä—Å—ã, –±—é–¥–∂–µ—Ç—ã
            5. **–ö–æ–Ω—Ç—Ä–æ–ª—å** - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Ä–∏—Å–∫–∏, –∫–∞—á–µ—Å—Ç–≤–æ
            6. **–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å** - –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞, –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤, –Ω–∞–¥–∑–æ—Ä–∞

            –ù–∞—á–∏–Ω–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ —Å–æ–∑–¥–∞–≤–∞–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é BIM-–ø–ª–∞—Ç—Ñ–æ—Ä–º—É!

      - name: Auto-create PR if changes made
        if: success()
        run: |
          git config --global user.name "Claude Assistant"
          git config --global user.email "claude-bot@anthropic.com"
          
          # Check if there are any changes
          if ! git diff --quiet; then
            echo "Changes detected, creating PR..."
            
            # Create a new branch
            BRANCH_NAME="claude-improvements-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git add -A
            git commit -m "Claude Assistant improvements

            - Code analysis and bug fixes
            - ƒåSN EN 206+A2 standards compliance
            - Architecture improvements
            - Auto-generated by Claude Assistant"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR using GitHub CLI (if available) or API
            if command -v gh &> /dev/null; then
              gh pr create --title "ü§ñ Claude Assistant Improvements" \
                          --body "Automated improvements by Claude Assistant:
            
            - Code analysis and bug fixes
            - Standards compliance (ƒåSN EN 206+A2)
            - Architecture improvements
            - Performance optimizations
            
            Please review the changes before merging." \
                          --head "$BRANCH_NAME" \
                          --base main
            else
              echo "GitHub CLI not available, PR creation skipped"
            fi
          else
            echo "No changes detected"
          fi
        continue-on-error: true

      - name: Comment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            let comment = '## ü§ñ Claude Assistant Status\n\n';
            
            if (context.job.status === 'success') {
              comment += '‚úÖ **Analysis completed successfully**\n\n';
              comment += '- Code reviewed and improved\n';
              comment += '- Standards compliance checked\n';  
              comment += '- Pull Request created (if changes made)\n';
            } else {
              comment += '‚ùå **Analysis encountered issues**\n\n';
              comment += 'Check the workflow logs for details.\n';
            }
            
            comment += '\n---\n*Powered by Claude Assistant - mention `@claude` for code assistance*';
            
            // Comment on the triggering issue/PR
            if (context.eventName === 'issue_comment' || context.eventName === 'issues') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else if (context.eventName === 'pull_request_review_comment' || context.eventName === 'pull_request_review') {
              github.rest.pulls.createReview({
                pull_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment,
                event: 'COMMENT'
              });
            }
