# üìù –û—Ç–≤–µ—Ç—ã –Ω–∞ –í–æ–ø—Ä–æ—Å—ã / Answers to Questions

## –í–æ–ø—Ä–æ—Å 1: "–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ç—ã –≤–∏–¥–∏—à—å –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ?"

### üèóÔ∏è –¢–æ–ø-5 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ü—Ä–æ–±–ª–µ–º

#### 1. ‚ùå **–ö–†–ò–¢–ò–ß–ù–û: –ü–æ–ª–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**

**–ß—Ç–æ –Ω–µ —Ç–∞–∫:**
- API –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã—Ç - –ª—é–±–æ–π –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ª—é–±—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- –ù–µ—Ç —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- –ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ AI API (Claude/OpenAI)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –∫—Ç–æ —á—Ç–æ –¥–µ–ª–∞–ª
- DoS –∞—Ç–∞–∫–∏ –±–µ–∑ –∑–∞—â–∏—Ç—ã

**–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**
–í–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É API –∫–ª—é—á–µ–π –∏–ª–∏ JWT —Ç–æ–∫–µ–Ω—ã. –ö–æ–¥ –≥–æ—Ç–æ–≤ –≤ `IMPLEMENTATION_GUIDE.md`.

---

#### 2. üìê **–ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–º–µ—Å—Ç–æ –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏**

**–ß—Ç–æ –Ω–µ —Ç–∞–∫:**
```
app/routers/
‚îî‚îÄ‚îÄ tzd_router.py  # –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–æ—É—Ç–µ—Ä!
```

–ü—Ä–∏ —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞—è–≤–ª—è–µ—Ç "–º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É", –Ω–æ:
- –°—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–æ—É—Ç–µ—Ä
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–º–µ—à–∞–Ω–∞ —Å HTTP –ª–æ–≥–∏–∫–æ–π
- –ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Å–ª–æ–∏ (services, repositories)
- –ö–æ–¥ —Ç—Ä—É–¥–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
app/
‚îú‚îÄ‚îÄ routers/          # HTTP —Å–ª–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ tzd_router.py
‚îÇ   ‚îú‚îÄ‚îÄ concrete_router.py
‚îÇ   ‚îî‚îÄ‚îÄ materials_router.py
‚îú‚îÄ‚îÄ services/         # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ tzd_service.py
‚îÇ   ‚îú‚îÄ‚îÄ file_service.py
‚îÇ   ‚îî‚îÄ‚îÄ analysis_service.py
‚îú‚îÄ‚îÄ repositories/     # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ document_repository.py
‚îî‚îÄ‚îÄ models/          # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
```

---

#### 3. üö¶ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Rate Limiting –∏ –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π**

**–ß—Ç–æ –Ω–µ —Ç–∞–∫:**
- –õ—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç DoS –∞—Ç–∞–∫
- –†–∞—Å—Ö–æ–¥—ã –Ω–∞ AI API –º–æ–≥—É—Ç –≤–∑–æ—Ä–≤–∞—Ç—å—Å—è

**–ü—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏:**
```python
# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å:
for i in range(10000):
    requests.post("/api/v1/tzd/analyze", files={"files": file})
    # –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å = –≤—ã–∑–æ–≤ Claude API = –¥–µ–Ω—å–≥–∏
```

**–†–µ—à–µ–Ω–∏–µ:**
–í–Ω–µ–¥—Ä–∏—Ç—å rate limiting (5-10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ IP). –ö–æ–¥ –≤ `IMPLEMENTATION_GUIDE.md`.

---

#### 4. üìä **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –ë–î**

**–ß—Ç–æ –Ω–µ —Ç–∞–∫:**
```python
# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
engine = create_async_engine(DATABASE_URL, echo=..., future=True)
```

–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –¢–∞–π–º–∞—É—Ç—ã
- Retry –ª–æ–≥–∏–∫–∞
- Health checks

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π:**
- –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ü–∞–¥–µ–Ω–∏–µ –ë–î –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

---

#### 5. üîç **–ü–æ–ª–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ observability**

**–ß—Ç–æ –µ—Å—Ç—å:**
```python
logging.basicConfig(level=logging.INFO)  # –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger.info("Server started")
```

**–ß–µ–≥–æ –Ω–µ—Ç:**
- ‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (JSON)
- ‚ùå Request ID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
- ‚ùå –ú–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Prometheus)
- ‚ùå –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ (Sentry)
- ‚ùå –ê–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚ùå –î–∞—à–±–æ—Ä–¥–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
–ö–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è –≤ production - –≤—ã –Ω–µ —É–∑–Ω–∞–µ—Ç–µ, –∏–ª–∏ —É–∑–Ω–∞–µ—Ç–µ —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ.

---

## –í–æ–ø—Ä–æ—Å 2: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π security —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö"

### üîê –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### 1. ‚ö†Ô∏è **–£—è–∑–≤–∏–º–æ—Å—Ç—å Race Condition –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤**

**–§–∞–π–ª:** `app/routers/tzd_router.py:127-134`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
content = await file.read()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å!

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏
if len(content) > 10 * 1024 * 1024:
    raise HTTPException(...)

with open(file_path, "wb") as f:
    f.write(content)  # –£–∂–µ –ø–æ–∑–¥–Ω–æ - —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏
```

**–ê—Ç–∞–∫–∞:**
1. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª 1GB
2. –°–µ—Ä–≤–µ—Ä —á–∏—Ç–∞–µ—Ç –≤–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å (`await file.read()`)
3. –¢–û–õ–¨–ö–û –ü–û–¢–û–ú –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑–º–µ—Ä
4. –ü–∞–º—è—Ç—å –∏—Å—á–µ—Ä–ø–∞–Ω–∞, —Å–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–µ—Ç

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
# Streaming —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ –ª–µ—Ç—É
size = 0
async with aiofiles.open(file_path, 'wb') as f:
    while chunk := await file.read(8192):  # –ü–æ—Ä—Ü–∏—è–º–∏!
        size += len(chunk)
        if size > max_size:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
            os.remove(file_path)
            raise HTTPException(...)
        await f.write(chunk)
```

---

#### 2. ‚ö†Ô∏è **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**

**–§–∞–π–ª:** `agents/tzd_reader/security.py:169-192`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
# –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç
with open(file_path, 'rb') as f:
    header = f.read(8)

if header.startswith(b'%PDF'):
    return True  # –°—á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
```

**–ê—Ç–∞–∫–∞ 1: –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π PDF**
```
%PDF-1.4          ‚Üê –í–∞–ª–∏–¥–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
1 0 obj
<</JavaScript (
  // –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥!
  app.alert("You are hacked!");
)>>
```
‚úÖ –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É, –Ω–æ –æ–ø–∞—Å–µ–Ω!

**–ê—Ç–∞–∫–∞ 2: DOCX —Å –º–∞–∫—Ä–æ—Å–∞–º–∏**
```
PK (ZIP —Å–∏–≥–Ω–∞—Ç—É—Ä–∞)  ‚Üê –í–∞–ª–∏–¥–Ω–∞—è
  ‚îî‚îÄ‚îÄ word/vbaProject.bin  ‚Üê –ú–∞–∫—Ä–æ—Å—ã (–≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–µ)
```
‚úÖ –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞–∫—Ä–æ—Å—ã!

**–ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ PDF –Ω–∞ JavaScript, —Ñ–æ—Ä–º—ã, —ç–∫—à–µ–Ω—ã
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ DOCX –Ω–∞ –º–∞–∫—Ä–æ—Å—ã (vbaProject.bin)
- ‚ùå –ê–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ùå Sandbox –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –≥–ª—É–±–æ–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ö–æ–¥ –≤ `IMPLEMENTATION_GUIDE.md`.

---

#### 3. ‚ö†Ô∏è **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã API –∫–ª—é—á–µ–π**

**–§–∞–π–ª—ã:** `app/core/config.py`, `app/core/llm_service.py`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
self.anthropic_api_key = os.getenv("ANTHROPIC_API_KEY")  # –ú–æ–∂–µ—Ç –±—ã—Ç—å None!
self.openai_api_key = os.getenv("OPENAI_API_KEY")        # –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π!
```

**–£—è–∑–≤–∏–º–æ—Å—Ç–∏:**
1. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –∫–ª—é—á–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
2. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–µ–π
3. –ö–ª—é—á–∏ –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –≤ –ª–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
4. –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ä–æ—Ç–∞—Ü–∏–∏
5. –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```python
# –ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
llm_service.anthropic_api_key = None
# ... 
# –ì–¥–µ-—Ç–æ –≥–ª—É–±–æ–∫–æ –≤ –∫–æ–¥–µ:
anthropic.create(api_key=None)  # Crash!
# –û—à–∏–±–∫–∞ —Ç–æ–ª—å–∫–æ –≤ production!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
def _get_required_key(self, key_name: str) -> str:
    value = os.getenv(key_name)
    if not value:
        raise ValueError(f"{key_name} –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!")
    if len(value) < 10:
        raise ValueError(f"{key_name} –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω!")
    return value
```

---

#### 4. ‚ö†Ô∏è **SQL Injection —Ä–∏—Å–∫ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ text()**

**–§–∞–π–ª:** `app/main.py:173`

**–û–ø–∞—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:**
```python
await session.execute(text("SELECT 1"))  # –°–µ–π—á–∞—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ
```

–ù–æ –µ—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å:
```python
# –û–ü–ê–°–ù–û! –ù–ï –î–ï–õ–ê–ô–¢–ï –¢–ê–ö!
user_id = request.query_params.get("id")
query = text(f"SELECT * FROM users WHERE id = {user_id}")
await session.execute(query)
```

**–ê—Ç–∞–∫–∞:**
```
GET /api/users?id=1 OR 1=1--
‚Üí SELECT * FROM users WHERE id = 1 OR 1=1--
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏!
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
# –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
query = text("SELECT * FROM users WHERE id = :user_id")
result = await session.execute(query, {"user_id": user_id})
```

---

#### 5. ‚ö†Ô∏è **–ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ**

**–§–∞–π–ª:** `app/routers/tzd_router.py:133-134`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
# –í async —Ñ—É–Ω–∫—Ü–∏–∏:
async def analyze_tzd_documents(...):
    with open(file_path, "wb") as f:  # ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç event loop!
        f.write(content)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è `open()` –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å event loop!

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç
- –ü–ª–æ—Ö–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- Timeouts

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
import aiofiles

async with aiofiles.open(file_path, "wb") as f:
    await f.write(content)
```

---

#### 6. ‚ö†Ô∏è **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**–§–∞–π–ª:** `app/routers/tzd_router.py:60-61`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
ai_engine: str = Form(default="auto")  # ‚ùå –õ—é–±–∞—è —Å—Ç—Ä–æ–∫–∞!
project_context: Optional[str] = Form(None)  # ‚ùå –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞!
```

**–ê—Ç–∞–∫–∏:**
```python
# 1. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π engine
POST /analyze
ai_engine=INVALID_ENGINE  # Crash!

# 2. –û–≥—Ä–æ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
POST /analyze
project_context="A" * 10000000  # 10MB —Å—Ç—Ä–æ–∫–∞, Memory exhausted!

# 3. Injection
project_context="'; DROP TABLE users--"  # –ï—Å–ª–∏ –ø–æ–ø–∞–¥–µ—Ç –≤ SQL
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
from pydantic import BaseModel, Field
from enum import Enum

class AIEngine(str, Enum):
    GPT = "gpt"
    CLAUDE = "claude"
    AUTO = "auto"

class AnalyzeRequest(BaseModel):
    ai_engine: AIEngine = AIEngine.AUTO
    project_context: Optional[str] = Field(None, max_length=1000)
```

---

#### 7. ‚ö†Ô∏è **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

**–§–∞–π–ª:** `app/main.py:71-83`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
app.add_middleware(
    CORSMiddleware,
    allow_credentials=True,    # ‚ùå –û–ø–∞—Å–Ω–æ —Å *
    allow_methods=["*"],       # ‚ùå –í—Å–µ –º–µ—Ç–æ–¥—ã
    allow_headers=["*"],       # ‚ùå –í—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)
```

**–†–∏—Å–∫–∏:**
- CSRF –∞—Ç–∞–∫–∏
- Credential leakage

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://yourdomain.com"],  # –¢–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ
    allow_credentials=True,
    allow_methods=["GET", "POST"],             # –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ
    allow_headers=["Content-Type", "Authorization"],
    max_age=3600
)
```

---

#### 8. ‚ö†Ô∏è **–£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**

**–§–∞–π–ª:** `app/routers/tzd_router.py:192`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
except Exception as e:
    raise HTTPException(
        status_code=500, 
        detail=f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"  # ‚ùå –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏!
    )
```

**–ß—Ç–æ –º–æ–∂–µ—Ç —É—Ç–µ—á—å:**
```
–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: FileNotFoundError: /tmp/secure_xyz/document.pdf
‚Üí –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: KeyError: 'anthropic_api_key'
‚Üí –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: psycopg2.OperationalError: FATAL: password authentication failed for user "postgres"
‚Üí –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```python
except SecurityError as e:
    # –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    raise HTTPException(status_code=400, detail=str(e))
except Exception as e:
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏
    logger.error(f"Internal error: {e}", exc_info=True)
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    raise HTTPException(
        status_code=500, 
        detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    )
```

---

## üìã –°–≤–æ–¥–Ω–∞—è –¢–∞–±–ª–∏—Ü–∞ –£—è–∑–≤–∏–º–æ—Å—Ç–µ–π

| ‚Ññ | –£—è–∑–≤–∏–º–æ—Å—Ç—å | –§–∞–π–ª | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è |
|---|-----------|------|-------------|--------------|
| 1 | Race condition –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ | tzd_router.py:127 | üî¥ –í—ã—Å–æ–∫–∞—è | –õ–µ–≥–∫–æ |
| 2 | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ | security.py:169 | üî¥ –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ |
| 3 | –ù–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–µ API –∫–ª—é—á–∏ | config.py | üî¥ –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ |
| 4 | SQL Injection —Ä–∏—Å–∫ | main.py:173 | üü° –°—Ä–µ–¥–Ω—è—è | –°–ª–æ–∂–Ω–æ |
| 5 | –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | tzd_router.py:133 | üü° –°—Ä–µ–¥–Ω—è—è | –õ–µ–≥–∫–æ |
| 6 | –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö | tzd_router.py:60 | üî¥ –í—ã—Å–æ–∫–∞—è | –õ–µ–≥–∫–æ |
| 7 | –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è CORS | main.py:71 | üü° –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ |
| 8 | –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ | tzd_router.py:192 | üü° –°—Ä–µ–¥–Ω—è—è | –õ–µ–≥–∫–æ |

---

## üéØ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–ü–µ—Ä–µ–¥ production)
1. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (2 —á–∞—Å–∞)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å rate limiting (1 —á–∞—Å)
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å streaming –∑–∞–≥—Ä—É–∑–∫—É (3 —á–∞—Å–∞)
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é API –∫–ª—é—á–µ–π (1 —á–∞—Å)

### –°—Ä–æ—á–Ω–æ (1-2 –Ω–µ–¥–µ–ª–∏)
5. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤ —Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (1 –¥–µ–Ω—å)
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (1 –¥–µ–Ω—å)
7. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (2 —á–∞—Å–∞)
8. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å async –æ–ø–µ—Ä–∞—Ü–∏–∏ (2 —á–∞—Å–∞)

### –í–∞–∂–Ω–æ (1 –º–µ—Å—è—Ü)
9. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã (2 –¥–Ω—è)
10. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å health checks (2 —á–∞—Å–∞)
11. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD (4 —á–∞—Å–∞)
12. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å API (1 –¥–µ–Ω—å)

---

## üìö –ì–¥–µ –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏—è?

–í—Å–µ —Ä–µ—à–µ–Ω–∏—è —Å –≥–æ—Ç–æ–≤—ã–º –∫–æ–¥–æ–º –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö:

1. **SECURITY_ARCHITECTURE_ANALYSIS.md** - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
2. **–ê–ù–ê–õ–ò–ó_–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò_RU.md** - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
3. **IMPLEMENTATION_GUIDE.md** - –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ –¥–ª—è copy-paste
4. **TESTING_STRATEGY.md** - –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üèÜ –ò—Ç–æ–≥–æ–≤–∞—è –û—Ü–µ–Ω–∫–∞

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|--------|--------|--------|
| –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è | 0/10 | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | 0/10 | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ | 4/10 | üü° –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤ | 6/10 | üü° –•–æ—Ä–æ—à–∞—è –±–∞–∑–∞ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API | 2/10 | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö | 5/10 | üü° –ë–∞–∑–æ–≤–∞—è |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | 6/10 | üü° –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | 3/10 | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ |
| **–ò–¢–û–ì–û** | **3.3/10** | **‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û** |

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** 10.01.2024  
**–í—Å–µ —Ä–µ—à–µ–Ω–∏—è —Å –∫–æ–¥–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.**
